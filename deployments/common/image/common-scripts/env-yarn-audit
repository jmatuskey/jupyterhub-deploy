#! /bin/bash

if [[ "$#" == "0" ]]; then
   cat <<EOF
usage:  env-yarn-audit <root-path> [fix [--force]]

Runs yarn audit on all discoverable yarn.lock files under
<root_path> to identify vulnerabilities in described packages.

Adding "fix" should result in innocuous package updates according to
semver rules to address vulnerabilities.

Adding "fix --force" will apply riskier package updates which are
considered "possibly breaking changes" according to semver rules.

There's no guarantee every package follows semver rules and that
the resulting "fixes" don't break something.
EOF
exit 2
fi

root_path=$1
shift

echo "==================== Installing yarn and yarn-audit-fix ================="
npm install -g yarn  2&>1  > /dev/null
npm install -g yarn-audit-fix  2&>1  > /dev/null

for lockfile in `find ${root_path} -name yarn.lock 2>/dev/null`; do
    audit_path=`dirname ${lockfile}`
    cd ${audit_path}
    echo "======================= Auditing ${audit_path} ====================="
    yarn audit --no-progress --level moderate
    if [[ "$1" == "fix" ]]; then
	echo "======================= Fixing ${audit_path} ====================="
	yarn-audit-fix --no-progress --audit-level moderate
	echo "======================= Followup Audit ${audit_path} ====================="
	yarn audit --no-progress --level moderate
    fi
done

npm cache clean --force
