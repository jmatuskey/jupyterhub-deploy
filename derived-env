#! /bin/bash -eu

export PATH="`pwd`/tools":${PATH}

# ----------------- derived inputs, nominally don't change --------------
# automatically sourced into setup-env

# Octarine AWS JupyterHub setup

if [ "$USE_CENTRAL_ECR" == "true" ]
then
    export ECR_REGISTRY=${CENTRAL_ECR_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
    export IMAGE_REPO=${DEPLOYMENT_NAME}
    export ECR_ACCOUNT_TO_USE=${CENTRAL_ECR_ACCOUNT_ID}
else
    export ECR_REGISTRY=${ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
    export IMAGE_REPO=${DEPLOYMENT_NAME}-user-image
    export ECR_ACCOUNT_TO_USE=${ACCOUNT_ID}
fi

export JUPYTERHUB_DIR=`pwd`

export COMMON_REPO=${IMAGE_REPO}

export ADMIN_ARN=arn:aws:iam::${ACCOUNT_ID}:role/${ADMIN_ROLENAME}

export IMAGE_DIR=`pwd`/deployments/${DEPLOYMENT_NAME}/image
export CONFIG_DIR=`pwd`/deployments/${DEPLOYMENT_NAME}/config

export COMMON_IMAGE_DIR=`pwd`/deployments/common/image
export COMMON_CONFIG_DIR=`pwd`/deployments/common/config

export COMMON_ID=${ECR_REGISTRY}/${COMMON_REPO}:${COMMON_TAG}
export IMAGE_ID=${ECR_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}

# --------------- general setup ---------------------------------

export TMOUT=7200
export TF_LOG=TRACE
export TF_LOG_PATH=terraform.log

alias awsu="awsudo -d 3600 $ADMIN_ARN"
alias terraform-init="awsu terraform init -backend-config=./backend.conf -backend-config=./backend.conf"
alias terraform-apply="awsu terraform apply --var-file=${DEPLOYMENT_NAME}.tfvars"
alias terraform-destroy="awsu terraform destroy -var-file=${DEPLOYMENT_NAME}.tfvars"
alias helm-destroy="awsu helm uninstall ${DEPLOYMENT_NAME}-${ENVIRONMENT}"
alias where="echo ${DEPLOYMENT_NAME}-${ENVIRONMENT}-${USE_FROZEN}"
alias update-kubeconfig="awsu aws eks update-kubeconfig --name $DEPLOYMENT_NAME"
alias pods="kubectl get pods -A"

# where,  failing for GitHub Actions even with bash shell
